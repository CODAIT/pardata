#
# Copyright 2020 IBM Corp. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

environment:
  matrix:
    - TOXENV: py36
      APPVEYOR_BUILD_WORKER_IMAGE: "Visual Studio 2013"
    - TOXENV: py37
      # Because MacOS and Linux are quite similar for our purposes, we only test one Python version on MacOS
      # to avoid surprise and conserve resource (we have only 1 test running concurrently on AppVeyor).'

      # We put this test right after the first Windows test because we only have 1 test running concurrently, and this
      # is the test that is the most likely to fail after the first Windows test has passed, because it is very
      # different from Windows.
      APPVEYOR_BUILD_WORKER_IMAGE: macOS
    - TOXENV: py37
      APPVEYOR_BUILD_WORKER_IMAGE: "Visual Studio 2015"
    - TOXENV: py38
      APPVEYOR_BUILD_WORKER_IMAGE: "Visual Studio 2017"
    - TOXENV: py39
      APPVEYOR_BUILD_WORKER_IMAGE: "Visual Studio 2019"

matrix:
  allow_failures:
    # TODO: We allow windows test to fail for now, so that we can work on to eliminate the failures by
    # observing the output of the CI. This must be removed eventually.
    - APPVEYOR_BUILD_WORKER_IMAGE: "Visual Studio 2013"
    - APPVEYOR_BUILD_WORKER_IMAGE: "Visual Studio 2015"
    - APPVEYOR_BUILD_WORKER_IMAGE: "Visual Studio 2017"
    - APPVEYOR_BUILD_WORKER_IMAGE: "Visual Studio 2019"

build: false

install:
  # AppVeyor requires us to manually source a virtualenv on macOS. This line is allowed to fail (and will fail) on other images.
  - source ~/venv3.7/bin/activate || (exit 0)
  - pip install -U tox

test_script:
  - tox -vv

branches:
  only:
    - master


notifications:
  # For email, only notify the author when the test fails, or succeeds after failing.
  - provider: Email
    to:
      - '{{commitAuthorEmail}}'
    on_build_success: false
    on_build_failure: true
    on_build_status_changed: true
  # AppVeyor doesn't allow us to silence PR CI runs specifically. See https://github.com/appveyor/ci/issues/272 . As a
  # compromise, we only send failure notifications.
  - provider: Slack
    incoming_webhook:
      secure: Hd8eEutJcY4vbHe8xMhidWkM/MglTw8Y3FpdbTqxYH4lTI7/MfnrrQa6QJqZyfEsAY4GKqh3jGTcai8vpjqno5QMOqVkFgU2v+PLtLR5Hrw=
    on_build_success: true # true for testing purposes
    on_build_failure: true
    on_build_status_changed: false
